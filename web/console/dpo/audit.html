<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSI DPDP CMS - Audit Explorer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../env.js"></script>
    <style>
        :root {
            --tsi-primary: #006A67;
            --tsi-accent: #008D8A;
            --background: #f4fbf9;
            --card-bg: #FFFFFF;
            --radius: 0.5rem;
        }

        body {
            background-color: var(--background);
            font-family: ui-sans-serif, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .primary-bg { background-color: var(--tsi-primary); }
        .primary-text { color: var(--tsi-primary); }

        /* Sidebar Styling */
        .sidebar {
            width: 250px;
            background-color: #f8fafc;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding-top: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 50;
            transition: transform 0.3s ease-in-out;
            transform: translateX(-250px);
        }

        .sidebar.open { transform: translateX(0); }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            margin: 5px 0;
            border-radius: 6px;
            color: #4a5568;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .nav-link:hover, .nav-link.active {
            background-color: #e5f5f4;
            color: var(--tsi-primary);
            font-weight: 600;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .table-header {
            background-color: #f1f5f9;
            font-weight: 600;
            color: #4a5568;
            text-align: left;
        }

        /* Actor Tags */
        .actor-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.15rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .tag-app { background-color: #e0f2fe; color: #0369a1; }
        .tag-system { background-color: #f1f5f9; color: #475569; }
        .tag-user { background-color: #f0fdf4; color: #166534; }

        /* Mobile Layout */
        .mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        @media (min-width: 1024px) {
            .sidebar { transform: translateX(0); }
            .mobile-header { display: none; }
            body { padding-left: 250px; }
        }
    </style>
</head>

<body class="flex lg:p-0">

<!-- Mobile Header -->
<div class="mobile-header lg:hidden">
    <button id="menu-toggle" class="p-2 rounded-md hover:bg-gray-100 primary-text">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>
    </button>
    <span class="text-xl font-bold primary-text">Audit Explorer</span>
</div>

<!-- Sidebar Navigation -->
<div id="sidebar" class="sidebar lg:relative flex flex-col justify-between">
    <div>
        <div class="px-5 pb-6 border-b border-gray-200 lg:block hidden">
            <span class="text-xl font-bold primary-text">TSI DPDP CMS</span>
        </div>
        <nav class="flex flex-col space-y-1 mt-4 px-3">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="policies.html" class="nav-link">Policies</a>
            <a href="principals.html" class="nav-link">Principals</a>
            <a href="compliance.html" class="nav-link">Compliance</a>
            <a href="grievances.html" class="nav-link">Grievances</a>
            <a href="audit_logs.html" class="nav-link active">Audit</a>
            <a href="reports.html" class="nav-link">Reports</a>
        </nav>
    </div>
    <div class="p-3 border-t border-gray-200">
        <div class="mt-2 text-sm text-gray-500 p-2 rounded-md hover:bg-gray-100 cursor-pointer flex justify-between items-center">
            <span id="username">DPO User</span>
            <a href="#" onclick="handleLogout()"><span class="text-xs font-semibold text-red-500">Logout</span></a>
        </div>
    </div>
</div>

<div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>

<!-- Main Content Area -->
<main class="flex-1 p-4 lg:p-8 overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-semibold text-gray-800">Audit Explorer</h1>
        <button id="download-xls-btn" onclick="downloadXLS()" class="primary-bg text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-opacity-90 flex items-center gap-2 transition-all shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Download XLS
        </button>
    </div>

    <!-- Audit List Card -->
    <div class="card">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Activity Logs</h2>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
            <div class="flex gap-3 flex-1 max-w-xl">
                <input type="text" id="principal-search" placeholder="Search by Data Principal (User ID)..." class="p-2 border border-gray-300 rounded-md text-sm w-full outline-none focus:ring-2 focus:ring-teal-600 focus:border-transparent">
                <select id="action-filter" class="p-2 border border-gray-300 rounded-md text-sm bg-white">
                    <option value="ALL">All Actions</option>
                    <option value="CONSENT_GIVEN">Consent Given</option>
                    <option value="CONSENT_WITHDRAWN">Consent Withdrawn</option>
                    <option value="ERASURE_REQUEST">Erasure Request</option>
                    <option value="POLICY_PUBLISHED">Policy Published</option>
                </select>
            </div>
            <span id="log-count" class="text-sm text-gray-500 font-medium">Fetching logs...</span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                <tr class="table-header">
                    <th class="px-4 py-3 text-xs uppercase tracking-wider">Timestamp</th>
                    <th class="px-4 py-3 text-xs uppercase tracking-wider">Principal ID</th>
                    <th class="px-4 py-3 text-xs uppercase tracking-wider">Action</th>
                    <th class="px-4 py-3 text-xs uppercase tracking-wider">Actor</th>
                    <th class="px-4 py-3 text-xs uppercase tracking-wider min-w-[300px]">Context Details</th>
                </tr>
                </thead>
                <tbody id="audit-table-body" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="5" class="p-8 text-center text-gray-400 italic">
                        Loading audit logs from the immutable store...
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<script>
    // --- Configuration ---
    const API_URL_AUDIT = ENV_SERVER_URL + '/api/v1/admin/audit';
    const AUTH_TOKEN = localStorage.getItem('authToken');
    const FIDUCIARY_ID = localStorage.getItem('fiduciary_id');
    document.getElementById('username').textContent = localStorage.getItem('username') || 'DPO User';

    let tableBody, countSpan, searchInput, actionFilter;
    let currentLogs = []; // Global variable to store fetched logs for export

    function toggleMenu() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebar-backdrop').classList.toggle('hidden');
    }

    function getActorTag(type, id) {
        let tagClass = 'tag-system';
        if (type === 'APP') tagClass = 'tag-app';
        if (type === 'USER') tagClass = 'tag-user';

        return `
            <div class="flex flex-col gap-0.5">
                <span class="actor-tag ${tagClass}">${type}</span>
                <span class="text-[9px] font-mono text-gray-400 truncate max-w-[120px]" title="${id}">ID: ${id || 'N/A'}</span>
            </div>
        `;
    }

    function createLogRow(log) {
        const row = document.createElement('tr');
        row.className = 'hover:bg-slate-50 transition-colors cursor-default align-top';

        // Format action badge
        const actionClass = log.audit_action.includes('WITHDRAWN') || log.audit_action.includes('ERASURE')
            ? 'bg-red-50 text-red-700 border-red-100'
            : 'bg-teal-50 text-teal-700 border-teal-100';

        // Format context details for inline display
        const context = log.context_details;
        const contextDisplay = typeof context === 'string' ? context : JSON.stringify(context, null, 2);

        row.innerHTML = `
            <td class="px-4 py-3 whitespace-nowrap">
                <p class="text-sm font-semibold text-gray-700">${new Date(log.timestamp).toLocaleDateString()}</p>
                <p class="text-[10px] text-gray-400 font-bold uppercase">${new Date(log.timestamp).toLocaleTimeString()}</p>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <span class="text-sm font-mono text-gray-600 bg-gray-100 px-2 py-0.5 rounded">${log.user_id}</span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <span class="text-[11px] font-bold px-2 py-1 rounded border ${actionClass}">${log.audit_action}</span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">${getActorTag(log.service_type, log.service_id)}</td>
            <td class="px-4 py-3 min-w-[300px]">
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 font-mono text-[10px] text-slate-600 overflow-x-auto max-h-[150px] scrollbar-thin">
                    <pre class="whitespace-pre-wrap break-words">${contextDisplay || "{}"}</pre>
                </div>
            </td>
        `;
        return row;
    }

    async function loadLogs() {
        tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Fetching logs...</td></tr>`;

        try {
            const response = await fetch(API_URL_AUDIT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${AUTH_TOKEN}` },
                body: JSON.stringify({
                    "_func": "list_audit_logs",
                    "fiduciary_id": FIDUCIARY_ID,
                    "search": searchInput.value,
                    "action_filter": actionFilter.value === 'ALL' ? '' : actionFilter.value,
                    "limit": 50
                })
            });

            const data = await response.json();
            const logs = data.data || data;

            currentLogs = logs; // Store for export
            tableBody.innerHTML = '';
            if (!logs || logs.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">No audit records found for this principal/filter.</td></tr>`;
            } else {
                logs.forEach(l => tableBody.appendChild(createLogRow(l)));
            }
            countSpan.textContent = `Displaying latest ${logs.length || 0} events`;

        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500 font-bold">Failed to load audit trail from the microservice.</td></tr>`;
        }
    }

    /**
     * XLS Export Utility using SheetJS
     */
    function downloadXLS() {
        if (!currentLogs || currentLogs.length === 0) {
            alert("No data available to download. Please ensure logs are loaded first.");
            return;
        }

        // Prepare data for Excel (Flattening objects for spreadsheet readability)
        const dataForExcel = currentLogs.map(log => ({
            "Timestamp": new Date(log.timestamp).toLocaleString(),
            "Principal ID": log.user_id,
            "Action Type": log.audit_action,
            "Actor Type": log.service_type,
            "Actor ID": log.service_id,
            "Context Details": typeof log.context_details === 'object'
                ? JSON.stringify(log.context_details)
                : log.context_details
        }));

        // Generate worksheet and workbook
        const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Audit Trail");

        // Format column widths for better default view
        const wscols = [
            { wch: 20 }, // Timestamp
            { wch: 25 }, // Principal ID
            { wch: 20 }, // Action Type
            { wch: 12 }, // Actor Type
            { wch: 36 }, // Actor ID
            { wch: 50 }  // Context Details
        ];
        worksheet['!cols'] = wscols;

        // Generate filename with timestamp
        const dateStamp = new Date().toISOString().split('T')[0];
        const filename = `TSI_Audit_Report_${FIDUCIARY_ID || 'Global'}_${dateStamp}.xlsx`;

        // Trigger native browser download
        XLSX.writeFile(workbook, filename);
    }

    // Initialize DOM links and listeners
    tableBody = document.getElementById('audit-table-body');
    countSpan = document.getElementById('log-count');
    searchInput = document.getElementById('principal-search');
    actionFilter = document.getElementById('action-filter');

    document.getElementById('menu-toggle').addEventListener('click', toggleMenu);
    document.getElementById('sidebar-backdrop').addEventListener('click', toggleMenu);
    actionFilter.addEventListener('change', loadLogs);

    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadLogs, 300);
    });

    loadLogs();

    window.handleLogout = () => { localStorage.clear(); window.location.href = "../index.html"; };
</script>
</body>
</html>