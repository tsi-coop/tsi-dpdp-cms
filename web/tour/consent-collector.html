<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSI DPDP CMS - Consent Collector - Tour</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Styling */
        body { font-family: ui-sans-serif, system-ui, sans-serif; margin: 0; padding: 0; background-color: #f4fbf9; color: #333; }
        .container { padding: 40px 20px; max-width: 900px; margin: 0 auto; }

        /* Banner & Modals */
        .cookie-banner {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: #1e293b; color: white; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; z-index: 1000; box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        .cookie-banner button {
            background-color: #006A67; color: white; border: none;
            padding: 10px 20px; margin-left: 10px; border-radius: 6px;
            cursor: pointer; font-weight: 600; transition: all 0.2s ease;
        }
        .cookie-banner button:hover { background-color: #004F4C; transform: translateY(-1px); }

        .preference-center-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.8); display: flex;
            justify-content: center; align-items: center; z-index: 1001;
            display: none;
        }
        .preference-center-content {
            background-color: white; padding: 35px; border-radius: 12px;
            max-width: 650px; width: 95%; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Tour UI Elements */
        .info-card {
            background: white; padding: 25px; border-radius: 12px;
            border-left: 6px solid #006A67; margin-bottom: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        h3 { color: #0f172a; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px; margin-top: 40px; font-size: 1.25rem; font-weight: 700; }

        .tour-link {
            color: #006A67; font-weight: 700; text-decoration: none;
            border-bottom: 2px solid transparent; transition: all 0.2s ease;
            cursor: pointer;
        }
        .tour-link:hover { border-bottom-color: #006A67; background-color: #f0fdfa; }

        /* Configuration Modal */
        .credentials-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .credentials-content {
            background: white; padding: 40px; border-radius: 16px;
            width: 420px; text-align: left; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .credentials-content h2 { margin-top: 0; color: #006A67; font-size: 1.5rem; font-weight: 700; }
        .credentials-content input {
            width: 100%; padding: 12px; margin: 8px 0 20px 0;
            border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box;
            font-family: monospace; font-size: 0.9rem;
        }
        .credentials-content button {
            background-color: #006A67; color: white; border: none;
            padding: 14px; border-radius: 8px; cursor: pointer;
            width: 100%; font-weight: 700; font-size: 1rem;
        }

        .privacy-trigger {
            position: fixed; bottom: 30px; right: 30px;
            background: white; border: 1px solid #e2e8f0;
            padding: 10px 15px; border-radius: 100px;
            font-size: 0.85rem; font-weight: 600; color: #006A67;
            cursor: pointer; z-index: 999; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .lang-select {
            background: #334155; color: white; border: 1px solid #475569;
            padding: 6px 12px; border-radius: 6px; font-size: 0.85rem;
            cursor: pointer; font-weight: 600; outline: none;
        }
        .lang-select-light {
            background: #f8fafc; color: #1e293b; border: 1px solid #cbd5e1;
            padding: 6px 12px; border-radius: 6px; font-size: 0.85rem;
            cursor: pointer; font-weight: 600;
        }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <a href="https://tsicoop.org" target="_blank"><img src="https://tsicoop.org/logo.svg" alt="TSI Coop" style="height: 50px;"/></a>
    </div>

    <h1 style="color: #006A67; font-size: 2.25rem; font-weight: 800; margin-bottom: 10px;">Consent & Identity Journey</h1>

    <div class="info-card">
        <p><strong>Operational Notice:</strong> This interactive tour demonstrates how the TSI DPDP CMS enforces data principal rights. The initial <strong>Notice</strong> (Banner) and <strong>Capture</strong> (Preference Center) workflows are foundational and trigger automatically based on the policy configuration.</p>
    </div>

    <h3>Consent Evidence & Auditability</h3>
    <p>Section 6 of the DPDP Act requires the Fiduciary to provide proof of consent. This action retrieves the cryptographically unique JSON artifact currently stored in your browser session.</p>
    <p><a href="javascript:void(0)" id="view-preferences" class="tour-link">→ View My Signed Consent Artifact</a></p>

    <h3>Identity Consolidation (Account Linking)</h3>
    <p>To ensure portable rights, users can link anonymous browser interactions to a registered Data Principal ID. This flow simulates collecting verified account details and updating the CMS identity registry.</p>
    <p><a href="javascript:void(0)" id="link-principal" class="tour-link">→ Link Anonymous Activity to Account</a></p>

    <h3>Compliance-Gated Interactions</h3>
    <p>Under DPDP guidelines, processing is strictly limited to consented purposes. These tests verify that application features are dynamically enabled or blocked based on your current preferences.</p>
    <div style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
        <a href="javascript:void(0)" id="validate-add-post" class="tour-link">Test: Add Community Post</a>
        <a href="javascript:void(0)" id="validate-provider-zone" class="tour-link">Test: Access Provider Zone</a>
        <a href="javascript:void(0)" id="view-profile" class="tour-link">Test: View User Profile</a>
    </div>
</div>

<!-- Dynamic Overlay Containers -->
<div id="cookie-consent-banner" class="cookie-banner"></div>

<div id="preference-center-overlay" class="preference-center-overlay">
    <div class="preference-center-content">
        <div id="preference-content-body"></div>
        <div class="footer-buttons" style="margin-top: 25px; text-align: right;">
            <button id="save-preferences" style="background: #006A67; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">Apply Choices</button>
        </div>
    </div>
</div>

<!-- Tour Setup Modal -->
<div id="credentials-modal" class="credentials-modal">
    <div class="credentials-content">
        <h2 style="margin-bottom: 10px;">Tour Configuration</h2>
        <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 25px;">Enter your app credentials to connect the tour to the TSI CMS backend.</p>

        <label style="display:block; font-weight:700; font-size: 0.75rem; text-transform: uppercase; color: #475569;">X-API-Key</label>
        <input type="text" id="api-key" placeholder="UUID Key">

        <label style="display:block; font-weight:700; font-size: 0.75rem; text-transform: uppercase; color: #475569;">X-API-Secret</label>
        <input type="text" id="api-secret" placeholder="Secret Token">

        <label style="display:block; font-weight:700; font-size: 0.75rem; text-transform: uppercase; color: #475569;">Policy ID</label>
        <input type="text" id="policy-id" placeholder="e.g. WEB_POLICY_V1">

        <button id="save-credentials-btn">Start Interactive Tour</button>
    </div>
</div>

<a href="javascript:void(0)" id="open-cookie-settings" class="privacy-trigger">Open Privacy Center</a>

<!-- Global Config Placeholder -->
<script type="application/json" id="config-data">
    {
        "tsi_dpdp_cms_localstoragekey": "tsi_dpdp_cms_key",
        "tsi_dpdp_cms_apibaseurl": "http://localhost:8080",
        "tsi_dpdp_cms_consentexpiry": 365
    }
</script>

<script>
/**
 * --- CONSENT MANAGER LOGIC (Integrated) ---
 */
const config = JSON.parse(document.getElementById('config-data').textContent);

const CONSENT_LOCAL_STORAGE_KEY = config.tsi_dpdp_cms_localstoragekey;
const CONSENT_EXPIRY_DAYS = parseInt(config.tsi_dpdp_cms_consentexpiry);
const API_BASE_URL = config.tsi_dpdp_cms_apibaseurl;

let API_KEY = null;
let API_SECRET = null;
let POLICY_ID = null;
let currentPolicy = null;
let currentLanguageContent = null;

const cookieBanner = document.getElementById('cookie-consent-banner');
const preferenceCenterOverlay = document.getElementById('preference-center-overlay');

// Global Headers Helper to ensure UTF-8 for both Request AND Expectation
const getHeaders = () => ({
    'Content-Type': 'application/json; charset=UTF-8',
    'Accept': 'application/json; charset=UTF-8',
    'X-API-Key': API_KEY,
    'X-API-Secret': API_SECRET
});

// UI Helpers
function displayCustomModal(title, bodyHtml, actionButtonHtml = '') {
    const existing = document.getElementById('custom-message-modal-overlay');
    if (existing) existing.remove();

    let modalHtml = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 3000;" id="custom-message-modal-overlay">
            <div style="background-color: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; font-family: Arial, sans-serif; color: #333; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
                <button style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer; color: #888;" onclick="document.getElementById('custom-message-modal-overlay').remove();">&times;</button>
                <h2 style="color:#006A67; margin-top:0; font-weight:700;">${title}</h2>
                <div style="font-size: 1rem; margin-top: 20px; line-height: 1.6; color: #475569;">${bodyHtml}</div>
                <div style="margin-top:30px;">${actionButtonHtml}</div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function resolvePolicyContent(data) {
    let content = data.policy_content || data;
    if (typeof content === 'string') {
        try { content = JSON.parse(content); } catch (e) { console.error("JSON Error", e); }
    }
    return content;
}

function getPreferredLanguage(policyMap) {
    const lang = (document.documentElement.lang || navigator.language || 'en').toLowerCase();
    const availableLangs = Object.keys(policyMap);
    if (availableLangs.includes(lang)) return lang;
    const baseLang = lang.split('-')[0];
    if (availableLangs.includes(baseLang)) return baseLang;
    return availableLangs.includes('en') ? 'en' : availableLangs[0];
}

/**
 * Switch the active language and re-render components.
 */
function changeLanguage(langCode) {
    const map = resolvePolicyContent(currentPolicy);
    if (map[langCode]) {
        currentLanguageContent = map[langCode];
        document.documentElement.lang = langCode;

        // Re-render UI
        renderCookieBanner();

        if (preferenceCenterOverlay.style.display === 'flex') {
            const currentPrefs = {};
            (currentLanguageContent.data_processing_purposes || []).forEach(p => {
                const el = document.getElementById(`toggle-${p.id}`);
                if (el) currentPrefs[p.id] = el.checked;
            });

            renderPreferenceCenter();

            (currentLanguageContent.data_processing_purposes || []).forEach(p => {
                const el = document.getElementById(`toggle-${p.id}`);
                if (el) el.checked = currentPrefs[p.id] !== undefined ? currentPrefs[p.id] : p.is_mandatory_for_service;
            });
        }
    }
}

async function fetchConsentPolicy() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/v1/client/policy`, {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({ "_func": "get_policy", "policy_id": POLICY_ID })
        });
        if (!response.ok) return null;
        const data = await response.json();
        return data.data || data;
    } catch (e) { return null; }
}

function getConsentState() {
    try {
        const stored = localStorage.getItem(CONSENT_LOCAL_STORAGE_KEY);
        if (stored) {
            const data = JSON.parse(stored);
            const expiryDate = new Date(data.timestamp);
            expiryDate.setDate(expiryDate.getDate() + CONSENT_EXPIRY_DAYS);
            if (new Date() < expiryDate) return data.preferences;
        }
    } catch (e) {}
    return null;
}

async function saveConsentState(preferences, mechanism) {
    const consentData = {
        preferences,
        timestamp: new Date().toISOString(),
        mechanism,
        policyVersion: currentPolicy ? currentPolicy.version : "1.0",
        policyId: POLICY_ID
    };
    localStorage.setItem(CONSENT_LOCAL_STORAGE_KEY, JSON.stringify(consentData));

    const userId = localStorage.getItem('tsi_dpdp_cms_principal_id') || localStorage.getItem('tsi_dpdp_cms_anon_id') || `anon_${Date.now()}`;
    localStorage.setItem('tsi_dpdp_cms_anon_id', userId);

    try {
        const fiduciaryId = currentPolicy ? currentPolicy.fiduciary_id : (localStorage.getItem('cc_fiduciary_id') || 'fiduciary_hub_abc');

        const payload = {
            _func: 'record_consent',
            user_id: userId,
            policy_id: POLICY_ID,
            fiduciary_id: fiduciaryId,
            language_selected: document.documentElement.lang || 'en', // FIX: Pass language
            consent_mechanism: mechanism,
            data_point_consents: Object.keys(preferences).map(id => {
                const purposeObj = (currentLanguageContent.data_processing_purposes || []).find(p => p.id === id);
                return {
                    data_point_id: id,
                    consent_granted: !!preferences[id],
                    purpose_agreed_to: purposeObj ? purposeObj.name : id,
                    timestamp_updated: new Date().toISOString()
                };
            })
        };

        const response = await fetch(`${API_BASE_URL}/api/v1/client/consent`, {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Consent Sync Failed:", errorText);
        }
    } catch (e) { console.error("Sync to DB failed", e); }

    if (cookieBanner) cookieBanner.style.display = 'none';
}

function renderCookieBanner() {
    if (!currentLanguageContent) return;
    const btn = currentLanguageContent.buttons || {};
    const map = resolvePolicyContent(currentPolicy);
    const languages = Object.keys(map);

    let langOptions = languages.map(l => `<option value="${l}" ${document.documentElement.lang === l ? 'selected' : ''}>${l.toUpperCase()}</option>`).join('');

    cookieBanner.innerHTML = `
        <div style="flex: 1; min-width: 300px;">
            <p style="margin:0; font-size: 0.95rem;">${currentLanguageContent.general_purpose_description || 'Compliance Notice'}.</p>
        </div>
        <div style="display:flex; align-items:center; gap:15px; flex-wrap: wrap; margin-top:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:0.7rem; color:#94a3b8; font-weight:700;">LANGUAGE:</span>
                <select onchange="changeLanguage(this.value)" class="lang-select">
                    ${langOptions}
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="handleAcceptAll()">${btn.accept_all || 'Accept All'}</button>
                <button onclick="handleRejectAll()" style="background:#64748b;">${btn.reject_all_non_essential || 'Reject'}</button>
                <button onclick="handleManagePreferences()" style="background:transparent; border:1px solid #475569;">${btn.manage_preferences || 'Preferences'}</button>
            </div>
        </div>
    `;
    cookieBanner.style.display = 'flex';
}

function renderPreferenceCenter() {
    if (!currentLanguageContent) return;
    const map = resolvePolicyContent(currentPolicy);
    const languages = Object.keys(map);
    let langOptions = languages.map(l => `<option value="${l}" ${document.documentElement.lang === l ? 'selected' : ''}>${l.toUpperCase()}</option>`).join('');

    let html = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:0.7rem; color:#64748b; font-weight:800;">UI LANGUAGE:</span>
                <select onchange="changeLanguage(this.value)" class="lang-select-light">
                    ${langOptions}
                </select>
            </div>
            <button onclick="closePreferenceCenter()" style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:#888;">&times;</button>
        </div>
        <h2 style="color:#006A67; font-size: 1.5rem; font-weight: 700;">${currentLanguageContent.title}</h2>
        <div style="margin-top:25px;">`;

    (currentLanguageContent.data_processing_purposes || []).forEach(p => {
        html += `
            <div style="padding:15px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:12px; background:#f8fafc;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong style="color:#1e293b;">${p.name}</strong>
                    ${p.is_mandatory_for_service ? '<span style="color:#059669; font-size:0.7rem; font-weight:800; text-transform:uppercase;">Mandatory</span>' : `
                        <input type="checkbox" id="toggle-${p.id}" style="width:20px; height:20px; cursor:pointer;">
                    `}
                </div>
                <p style="font-size:0.85rem; color:#64748b; margin-top:4px; line-height:1.4;">${p.description}</p>
            </div>
        `;
    });
    document.getElementById('preference-content-body').innerHTML = html + "</div>";
}

function handleAcceptAll() {
    const prefs = {};
    currentLanguageContent.data_processing_purposes.forEach(p => prefs[p.id] = true);
    saveConsentState(prefs, 'accept_all_banner');
}

function handleRejectAll() {
    const prefs = {};
    currentLanguageContent.data_processing_purposes.forEach(p => prefs[p.id] = p.is_mandatory_for_service);
    saveConsentState(prefs, 'reject_all_banner');
}

function handleManagePreferences() {
    const prefs = getConsentState() || {};
    renderPreferenceCenter();
    (currentLanguageContent.data_processing_purposes || []).forEach(p => {
        const el = document.getElementById(`toggle-${p.id}`);
        if (el) el.checked = prefs[p.id] !== undefined ? prefs[p.id] : p.is_mandatory_for_service;
    });
    preferenceCenterOverlay.style.display = 'flex';
    cookieBanner.style.display = 'none';
}

document.getElementById('save-preferences').onclick = () => {
    const prefs = {};
    currentLanguageContent.data_processing_purposes.forEach(p => {
        const el = document.getElementById(`toggle-${p.id}`);
        prefs[p.id] = el ? el.checked : p.is_mandatory_for_service;
    });
    saveConsentState(prefs, 'save_preferences_center');
    preferenceCenterOverlay.style.display = 'none';
};

function closePreferenceCenter() { preferenceCenterOverlay.style.display = 'none'; }

// --- Tour Actions ---

function initiateLinkPrincipalFlow() {
    const anonymousUserId = localStorage.getItem('tsi_dpdp_cms_anon_id');
    const existingPrincipal = localStorage.getItem('tsi_dpdp_cms_principal_id');

    if (existingPrincipal) {
        displayCustomModal("Account Already Linked", `This session is already associated with Data Principal: <strong>${existingPrincipal}</strong>.`);
        return;
    }

    const body = `
        <div style="text-align: left;">
            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 20px;">Linking associates your anonymous choices with your verified account for portable rights management.</p>

            <label style="display:block; font-size:0.8rem; font-weight:700; margin-bottom:5px; color:#475569; text-transform:uppercase;">Data Principal - User Id/Email</label>
            <input type="email" id="link-user-email" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px;" placeholder="john@example.com">

            <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; margin-top: 20px;">
                <p style="font-size: 0.7rem; color: #94a3b8; margin: 0;">Anonymous Target ID:</p>
                <p style="font-size: 0.8rem; font-family: monospace; color: #475569; word-break: break-all; margin: 0;"><strong>${anonymousUserId || 'Session Not Found'}</strong></p>
            </div>
        </div>
    `;

    const action = `<button id="submit-link-btn" style="background:#006A67; color:white; border:none; padding:14px; border-radius:8px; cursor:pointer; width:100%; font-weight:700; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">Consolidate & Link Identity</button>`;

    displayCustomModal("Link Data Principal", body, action);

    document.getElementById('submit-link-btn').onclick = async () => {
        const email = document.getElementById('link-user-email').value.trim();
        if (!email) return alert("User Id/ Email mandatory for linking.");

        const btn = document.getElementById('submit-link-btn');
        btn.disabled = true;
        btn.textContent = "Posting to Registry...";

        try {
            const fiduciaryId = currentPolicy ? currentPolicy.fiduciary_id : (localStorage.getItem('cc_fiduciary_id') || 'fiduciary_hub_abc');

            const payload = {
                _func: "link_user",
                anonymous_user_id: anonymousUserId || "anon_undefined",
                authenticated_user_id: email,
                fiduciary_id: fiduciaryId,
                language_selected: document.documentElement.lang || 'en', // FIX: Pass language
                meta: { name }
            };

            const res = await fetch(`${API_BASE_URL}/api/v1/client/consent`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                localStorage.setItem('tsi_dpdp_cms_principal_id', email);
                const currentPrefs = getConsentState() || {};
                await saveConsentState(currentPrefs, 'account_linked_sync');

                displayCustomModal("Identity Linked!", `<p>Successfully linked <strong>${anonymousUserId}</strong> to <strong>${email}</strong>.</p><p style="color: #059669; font-weight: 700; margin-top: 10px;">✓ Consent records synchronized for the linked user.</p>`);
            } else {
                const errData = await res.json().catch(() => ({}));
                alert("Backend Error: " + (errData.message || "The server rejected the identity consolidation request."));
            }
        } catch (e) {
            console.error("Linking Post Error:", e);
            alert("Network Error: Could not reach the CMS Registry. Please check backend status.");
        } finally {
            btn.disabled = false;
            btn.textContent = "Consolidate & Link Identity";
        }
    };
}

async function initConsentManager() {
    API_KEY = config.tsi_dpdp_cms_apikey;
    API_SECRET = config.tsi_dpdp_cms_apisecret;
    POLICY_ID = config.tsi_dpdp_cms_policyid;

    const rawPolicy = await fetchConsentPolicy();
    if (!rawPolicy) return;

    currentPolicy = rawPolicy;
    const map = resolvePolicyContent(rawPolicy);
    const lang = getPreferredLanguage(map);
    currentLanguageContent = map[lang];
    document.documentElement.lang = lang;

    renderCookieBanner();
    renderPreferenceCenter();

    const bind = (id, fn) => {
        const el = document.getElementById(id);
        if (el) el.onclick = (e) => { e.preventDefault(); fn(); };
    };

    bind('view-preferences', () => {
        const stored = localStorage.getItem(CONSENT_LOCAL_STORAGE_KEY);
        displayCustomModal("Consent Artifact", stored ? `<pre style="background:#f1f5f9; padding:15px; border-radius:8px; font-size:0.8rem; overflow-x:auto;">${JSON.stringify(JSON.parse(stored), null, 2)}</pre>` : '<p>Interact with the banner to generate an artifact.</p>');
    });

    bind('link-principal', initiateLinkPrincipalFlow);
    bind('open-cookie-settings', handleManagePreferences);

    bind('validate-add-post', () => {
        const state = getConsentState();
        if (state && state.purpose_community_engagement) {
            displayCustomModal("Access Granted!", "Verification successful. You have granted 'Community Engagement' consent.");
        } else {
            displayCustomModal("Access Denied", "Requires 'Community Engagement' consent.", `<button onclick="handleManagePreferences()" style="background:#006A67; color:white; padding:10px 20px; border-radius:6px; border:none; cursor:pointer;">Grant Consent</button>`);
        }
    });

    bind('validate-provider-zone', () => {
        const state = getConsentState();
        if (state && state.purpose_solution_service_training_showcase) {
            displayCustomModal("Access Granted!", "Verification successful. You have granted 'Solutions & Services' consent.");
        } else {
            displayCustomModal("Access Denied", "Requires 'Solutions & Services Showcase' consent.", `<button onclick="handleManagePreferences()" style="background:#006A67; color:white; padding:10px 20px; border-radius:6px; border:none; cursor:pointer;">Update Preferences</button>`);
        }
    });

    bind('view-profile', () => displayCustomModal("User Dashboard", "This view demonstrates the right to access (Section 11) for a verified Data Principal."));

    if (getConsentState()) cookieBanner.style.display = 'none';
}

// --- App Bootstrap ---
document.addEventListener('DOMContentLoaded', () => {
    if (!config.tsi_dpdp_cms_apikey) {
        document.getElementById('credentials-modal').style.display = 'flex';
    } else {
        initConsentManager();
    }
});



document.getElementById('save-credentials-btn').onclick = () => {
    const key = document.getElementById('api-key').value.trim();
    const secret = document.getElementById('api-secret').value.trim();
    const policyId = document.getElementById('policy-id').value.trim();

    if (key && secret && policyId) {

        // 1. Clear the main consent artifact
        localStorage.removeItem(config.tsi_dpdp_cms_localstoragekey);

        // 2. Clear identity trackers (Anonymous ID and Linked Principal ID)
        localStorage.removeItem('tsi_dpdp_cms_anon_id');
        localStorage.removeItem('tsi_dpdp_cms_principal_id');
        localStorage.removeItem('cc_fiduciary_id');

        config.tsi_dpdp_cms_apikey = key;
        config.tsi_dpdp_cms_apisecret = secret;
        config.tsi_dpdp_cms_policyid = policyId;
        document.getElementById('credentials-modal').style.display = 'none';
        initConsentManager();
    }
};
</script>
</body>
</html>