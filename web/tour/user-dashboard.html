<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSI DPDP CMS - User Dashboard Mock</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        :root {
            --tsi-primary: #006A67; /* Primary Dark Teal Color */
            --tsi-accent: #008D8A; /* Slightly lighter for accents */
            --background: #f4fbf9; /* Light, clean background */
            --card-bg: #FFFFFF;
            --border: 20 5.9% 90%;
            --radius: 0.5rem;
        }

        body {
            background-color: var(--background);
            font-family: ui-sans-serif, system-ui, sans-serif;
            min-height: 100vh;
            margin: 0;
        }

        .header-bg {
            background-color: var(--tsi-primary);
        }

        .card {
            background-color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: var(--radius);
            border: 1px solid #e2e8f0;
        }

        .primary-text {
            color: var(--tsi-primary);
        }

        .action-button {
            background-color: var(--tsi-primary);
            color: white;
            transition: background-color 0.3s ease;
        }

        .action-button:hover {
            background-color: #004F4C;
        }

        .table-header {
            background-color: #f1f5f9;
            font-weight: 600;
            color: #4a5568;
            text-align: left;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            color: #555;
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
        }

        /* ID Capture Modal specific styles */
        #id-capture-modal .modal-content {
            max-width: 400px;
            text-align: center;
        }

        .policy-detail-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #cbd5e1;
        }
    </style>
</head>

<body>

<!-- Main Dashboard Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <h1 class="text-3xl font-bold primary-text mb-6">User Dashboard Mock</h1>

  <!-- User Information (Simplified Display) -->
  <div class="card p-4 mb-6">
    <p class="text-lg font-semibold primary-text" id="profile-name">Fetching Profile...</p>
    <p class="text-sm text-gray-600" id="profile-email"></p>
    <p class="text-xs text-gray-400" id="profile-user-id">ID: </p>
  </div>


  <!-- Tabbed Interface for Main Content -->
  <div class="mt-4">
    <div class="border-b border-gray-200">
      <nav class="flex space-x-6 -mb-px">
        <button id="tab-consent" data-tab="consent" class="tab-button primary-text border-b-2 font-semibold border-current pb-2 text-sm transition-colors">
          Consent History & Manager
        </button>
        <button id="tab-grievance" data-tab="grievance" class="tab-button text-gray-500 hover:border-gray-300 border-b-2 border-transparent pb-2 text-sm transition-colors">
          Grievance & Requests Tracking
        </button>
      </nav>
    </div>

    <div id="dashboard-content" class="pt-6 card p-6">
      <!-- Content will load here -->
      <p class="text-center text-gray-500">Loading data...</p>
    </div>
  </div>

</main>

<!-- Footer (Basic) -->
<footer class="bg-gray-50 border-t" style="width: 100%;">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-gray-600 text-sm">
    &copy; 2025 TSI Coop. | <a href="#" class="hover:underline primary-text">Privacy Policy</a>
  </div>
</footer>

<!-- Modal for Data Principal ID Capture -->
<div id="id-capture-modal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="text-xl font-semibold primary-text mb-3">Data Principal</h2>
    <p class="text-sm text-gray-600 mb-4">Please enter your authenticated Data Principal ID to access your dashboard.</p>

    <form id="id-capture-form">
      <div>
        <label for="api-key" class="block text-sm font-medium text-gray-700">API Key</label>
        <input type="text" id="api-key" required value=""
               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
      </div>
      <div>
        <label for="api-secret" class="block text-sm font-medium text-gray-700">API Secret</label>
        <input type="text" id="api-secret" required value=""
               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
      </div>
      <div>
        <label for="input-principal-id" class="block text-sm font-medium text-gray-700">User ID / Email</label>
        <input type="text" id="input-principal-id" required value=""
               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
      </div>
      <div class="mt-6">
        <button type="submit" class="action-button px-4 py-2 rounded-md text-sm font-medium w-full">
          Access Dashboard
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal for Granular Consent Details (View Details) -->
<div id="detail-modal-overlay" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close-btn" onclick="document.getElementById('detail-modal-overlay').style.display='none'">&times;</button>
    <h2 class="text-xl font-semibold primary-text mb-3">Consent Record Details</h2>
    <p class="text-sm text-gray-500 mb-4">Record ID: <code id="modal-record-id"></code></p>

    <h3 class="text-lg font-semibold border-b pb-1">Granular Preferences:</h3>
    <div id="granular-details-body" class="space-y-2 mt-2 text-sm">
      <!-- Granular Consent Status Loaded Here -->
    </div>

    <h3 class="text-lg font-semibold border-b pb-1 mt-6">Provenance:</h3>
    <div id="provenance-details-body" class="space-y-1 mt-2 text-sm text-gray-600">
      <!-- Provenance Data Loaded Here -->
    </div>

    <div class="mt-6 text-right">
      <button id="initiate-erasue-btn" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700">
        Initiate Erasure
      </button>
    </div>
  </div>
</div>


<script>
        // --- Configuration & API Endpoints ---
        const API_BASE_URL = 'http://localhost:8080/api/v1';
        const API_CONSENT = `${API_BASE_URL}/client/consent`;
        const API_GRIEVANCE = `${API_BASE_URL}/grievances`;
        const API_USER_PROFILE = `${API_BASE_URL}/users/profile`;

        // Local Storage Keys
        const LOCAL_USER_ID_KEY = 'dp_user_id';
        const LOCAL_USER_NAME_KEY = 'dp_user_name';
        const X_API_KEY = 'x_api_key';
        const X_API_SECRET = 'x_api_secret';

        // --- Cache for current data ---
        let consentHistoryCache = [];
        let grievanceCache = [];



        // --- DOM Elements ---
        const contentArea = document.getElementById('dashboard-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        const idCaptureModal = document.getElementById('id-capture-modal');
        const idCaptureForm = document.getElementById('id-capture-form');
        const principalIdInput = document.getElementById('input-principal-id');
        const apikeyInput = document.getElementById('api-key');
        const apisecretInput = document.getElementById('api-secret');

        // --- Modal Detail Elements ---
        const detailModalOverlay = document.getElementById('detail-modal-overlay');
        const modalRecordId = document.getElementById('modal-record-id');
        const modalRecordStatus = document.getElementById('modal-record-status');
        const granularDetailsBody = document.getElementById('granular-details-body');
        const provenanceDetailsBody = document.getElementById('provenance-details-body');
        const profileNameDisplay = document.getElementById('profile-name');
        const profileUserIdDisplay = document.getElementById('profile-user-id');
        const userDisplayName = document.getElementById('user-display-name');


        // --- Utility Functions ---

        function formatTimestamp(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleString();
        }

        function createStatusBadge(status, colorClass) {
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClass}">${status.replace(/_/g, ' ')}</span>`;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'ACTIVE':
                case 'RESOLVED': return 'bg-green-100 text-green-800';
                case 'IN_PROGRESS':
                case 'PENDING_DPO_REVIEW': return 'bg-yellow-100 text-yellow-800';
                case 'WITHDRAWN':
                case 'ERASURE_REQUEST': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function calculateDaysLeft(deadline) {
            if (!deadline) return 'N/A';
            const now = new Date();
            const due = new Date(deadline);
            const diffTime = due.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return `<span class="text-red-600 font-bold">${Math.abs(diffDays)} Days Overdue</span>`;
            if (diffDays <= 5) return `<span class="text-orange-600 font-bold">${diffDays} Days Left</span>`;
            return `${diffDays} Days Left`;
        }

        // --- API & Data Fetching Functions ---

        async function fetchUserProfile(userId) {
            try {
                // In production: fetch profile data
                console.log(`[API] Fetching profile for ${userId}...`);

                // MOCK RESPONSE
                return {
                    name: "Data Principal " + userId.substring(3, 8).toUpperCase(),
                    email: userId + "@privacyhub.com",
                    userId: userId
                };
            } catch (e) {
                return { name: "Error Loading User", email: "N/A", userId: userId };
            }
        }

        // --- API 1: Consent History ---
        async function fetchConsentHistory(userId) {
            try {
                const payload = { "_func": "list_consent_history", "user_id": userId, "limit": 50 };

                const response = await fetch(`${API_CONSENT}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json',
                        'X-API-Key': localStorage.getItem(X_API_KEY),
                        'X-API-Secret': localStorage.getItem(X_API_SECRET)},
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Status ${response.status}`);
                const data = await response.json();

                if (data.success && Array.isArray(data.data)) {
                    consentHistoryCache = data.data;
                    return data.data;
                } else {
                    console.warn("API returned successful status but no data or success=false:", data.message);
                    return [];
                }
            } catch (e) {
                console.error("Error fetching consent history:", e);
                return [];
            }
        }

        // --- API 2: Grievance List ---
        async function fetchGrievances(userId) {
            try {
                const payload = { "_func": "list_user_requests", "user_id": userId, "sort_by": "SUBMISSION_DATE_DESC" };

                const response = await fetch(`${API_GRIEVANCE}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json',
                               'X-API-Key': localStorage.getItem(X_API_KEY),
                               'X-API-Secret': localStorage.getItem(X_API_SECRET)
                         },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Status ${response.status}`);
                const data = await response.json();

                if (data.success && Array.isArray(data.data)) {
                    grievanceCache = data.data;
                    return data.data;
                } else {
                    console.warn("API returned successful status but no grievance data:", data.message);
                    return [];
                }
            } catch (e) {
                console.error("Error fetching grievances:", e);
                return [];
            }
        }

        // --- API 3: Withdraw Consent ---
        async function withdrawConsent(userId) {
            if (!confirm("CONFIRM: Are you sure you want to withdraw ALL non-mandatory consent? This is irreversible and triggers data purge.")) return false;

            try {
                const payload = {
                    "_func": "withdraw_consent",
                    "user_id": userId,
                    "fiduciary_id": "TSI_COOP_ID_123", // Must be known
                    "reason": "User requested complete withdrawal via dashboard."
                };

                const response = await fetch(`${API_CONSENT}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("Withdrawal request successful! Data purge workflow initiated.");
                    loadDashboardData(userId);
                    return true;
                } else {
                    alert("Withdrawal failed. Check API response.");
                    return false;
                }
            } catch (e) {
                alert("Network error during withdrawal.");
                return false;
            }
        }


        // --- Data Orchestration & Initialization ---

        async function loadDashboardData(userId) {
            // Update UI with current user profile
            const userProfile = await fetchUserProfile(userId);
            //userDisplayName.textContent = `Welcome, ${userProfile.name.split(' ')[0]}!`;
            //profileNameDisplay.textContent = userProfile.name;
            profileUserIdDisplay.textContent = `ID: ${userId}`;

            // Fetch all required data concurrently
            const [consentHistory, grievances] = await Promise.all([
                fetchConsentHistory(userId),
                fetchGrievances(userId)
            ]);

            // Cache data
            consentHistoryCache = consentHistory;
            grievanceCache = grievances;

            // Render data for the active tab (which is 'consent' by default)
            setActiveTab('consent');
        }

        async function loadActiveTab(userId) {
            const activeTab = document.querySelector('.tab-button.primary-text').dataset.tab;
            contentArea.innerHTML = `<p class="text-center text-gray-500">Loading ${activeTab} data...</p>`;

            // Render content from cache
            if (activeTab === 'consent') {
                renderConsentContent(consentHistoryCache);
            } else if (activeTab === 'grievance') {
                renderGrievanceContent(grievanceCache);
            }
        }


        // --- Dynamic Content Renderers ---

        function renderConsentContent(history) {
            const userId = localStorage.getItem(LOCAL_USER_ID_KEY);
            const activeRecord = history.find(r => r.is_active_consent); // Assuming active consent flag exists
            const grantedCount = activeRecord ? Object.values(activeRecord.data_point_consents).filter(v => v).length : 0;
            const totalPurposes = activeRecord ? Object.keys(activeRecord.data_point_consents).length : 0;
            const percentage = totalPurposes > 0 ? ((grantedCount / totalPurposes) * 100).toFixed(0) : 0;


            const consentRows = history.map(record => {
                const isActive = record.is_active_consent;
                const status = record.status || 'N/A';
                return `
                <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-mono text-gray-700">...${record.id.slice(-8)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${record.policy_id} (v${record.policy_version})</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formatTimestamp(record.timestamp)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${record.consent_mechanism}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">
                        ${createStatusBadge(status, getStatusColor(status))}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">${isActive ? 'Yes' : 'No'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button class="text-indigo-600 hover:text-indigo-900 text-xs hover:underline" onclick="viewConsentDetails('${record.id}')">View Granular</button>
                    </td>
                </tr>
            `}).join('');

            contentArea.innerHTML = `
                <h2 class="text-xl font-semibold mb-4 primary-text">Current Consent Status & Manager</h2>

                <div class="mb-6 p-4 border rounded-lg bg-indigo-50/50">
                    <p class="text-sm font-medium text-gray-700">Overall Status (User: ${userId}):</p>
                    <div class="flex items-center justify-between">
                         <span class="text-2xl font-bold text-green-700">${percentage}% of Purposes Granted</span>
                         <button onclick="withdrawConsent('${userId}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium text-sm">
                            Withdraw All Consent
                         </button>
                    </div>
                     <p class="text-xs text-gray-500 mt-1">You currently have ${grantedCount} active grants out of ${totalPurposes} defined purposes.</p>
                </div>

                <h3 class="text-lg font-semibold mt-6 mb-3 primary-text">Full Consent History</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Record ID</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Policy Ref</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mechanism</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Active?</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${consentRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderGrievanceContent(requests) {
            const requestRows = requests.map(item => `
                <tr>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.id}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700">${item.type.replace(/_/g, ' ')}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formatTimestamp(item.submission_timestamp)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${calculateDaysLeft(item.due_date)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">
                        ${createStatusBadge(item.status, getStatusColor(item.status))}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button class="primary-text text-xs hover:underline" onclick="alert('Viewing subject: ${item.subject}')">Track Log</button>
                    </td>
                </tr>
            `).join('');

            contentArea.innerHTML = `
                <h2 class="text-xl font-semibold mb-4 primary-text">Requests & Grievance Redressal</h2>

                <div class="flex justify-end mb-4 gap-2">
                    <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-medium text-sm hover:bg-gray-300" onclick="alert('Opening Data Access Request Form')">
                        Request Data Access
                    </button>
                    <button class="action-button px-4 py-2 rounded-md font-medium text-sm" onclick="alert('Opening New Grievance Form')">
                        Submit New Grievance
                    </button>
                </div>

                <h3 class="text-lg font-semibold mt-6 mb-3 primary-text">Submitted Requests</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${requestRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- Modal Detail Viewer (View Granular) ---

        function viewConsentDetails(recordId) {
            // Find the record based on ID from the cache
            const record = consentHistoryCache.find(r => r.id === recordId);
            if (!record) return alert(`Record ID ${recordId} not found in local cache.`);

            // Populate modal
            modalRecordId.textContent = record.id;
            modalRecordStatus.innerHTML = createStatusBadge(record.status, getStatusColor(record.status));

            // Populate Granular Details
            let granularHtml = '';
            const preferences = record.data_point_consents || {};

            for (const key in preferences) {
                if (preferences.hasOwnProperty(key)) {
                    const isGranted = preferences[key];
                    const statusBadge = isGranted
                        ? `<span class="text-green-600">GRANTED</span>`
                        : `<span class="text-red-600">DENIED</span>`;

                    granularHtml += `
                        <div class="policy-detail-item">
                            <p class="text-gray-800 font-medium">${key.charAt(0).toUpperCase() + key.slice(1)}:</p>
                            <p class="ml-4">${statusBadge}</p>
                        </div>
                    `;
                }
            }
            granularDetailsBody.innerHTML = granularHtml;

            // Populate Provenance Details
            provenanceDetailsBody.innerHTML = `
                <p><strong>Policy Version:</strong> ${record.policy_version} | <strong>Mechanism:</strong> ${record.consent_mechanism}</p>
                <p><strong>Date Recorded:</strong> ${formatTimestamp(record.timestamp)}</p>
                <p><strong>IP Address:</strong> ${record.ip_address || 'Unknown'} </p>
            `;

            // Show Modal
            detailModalOverlay.style.display = 'flex';
        }


        // --- Data Orchestration & Initialization ---

        async function loadDashboardData(userId) {
            // Update UI with current user profile
            const userProfile = await fetchUserProfile(userId);
            //userDisplayName.textContent = `Welcome, ${userProfile.name.split(' ')[0]}!`;
            //profileNameDisplay.textContent = userProfile.name;
            profileUserIdDisplay.textContent = `ID: ${userId}`;

            // Fetch all required data sequentially/concurrently
            const [consentHistory, grievances] = await Promise.all([
                fetchConsentHistory(userId),
                fetchGrievances(userId)
            ]);

            // Cache data
            consentHistoryCache = consentHistory;
            grievanceCache = grievances;

            // Render data for the active tab (which is 'consent' by default)
            setActiveTab('consent');
        }

        function setActiveTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('border-current', 'font-semibold', 'primary-text');
                    button.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300');
                } else {
                    button.classList.remove('border-current', 'font-semibold', 'primary-text');
                    button.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300');
                }
            });

            // Trigger content render based on tab
            const userId = localStorage.getItem(LOCAL_USER_ID_KEY);

            if (userId) {
                if (tabId === 'consent') {
                    renderConsentContent(consentHistoryCache);
                } else if (tabId === 'grievance') {
                    renderGrievanceContent(grievanceCache);
                }
            } else {
                contentArea.innerHTML = `<p class="text-center text-red-600 font-bold">Error: User ID not found. Please refresh and enter your ID.</p>`;
            }
        }

        function handleLogout() {
            // Clear all local user and session data
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            localStorage.removeItem(LOCAL_USER_ID_KEY);
            window.location.href = "login.html";
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check for existing user ID
            const existingUserId = localStorage.getItem(LOCAL_USER_ID_KEY);
            if (!existingUserId) {
                document.getElementById('id-capture-modal').style.display = 'flex';
            } else {
                 // Load data based on stored ID
                 loadDashboardData(existingUserId);
            }


            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    setActiveTab(e.target.dataset.tab);
                });
            });

             // Form submission handler for ID capture modal
            document.getElementById('id-capture-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const principalId = principalIdInput.value.trim();
                const apikey = apikeyInput.value.trim();
                const apisecret = apisecretInput.value.trim();

                if (principalId) {
                    // Simulate successful authentication and save DP ID
                    localStorage.setItem(LOCAL_USER_ID_KEY, principalId);
                    localStorage.setItem(LOCAL_USER_NAME_KEY, "Authenticated User (" + principalId + ")");
                    localStorage.setItem(X_API_KEY, apikey);
                    localStorage.setItem(X_API_SECRET, apisecret);
                    document.getElementById('id-capture-modal').style.display = 'none';

                    // Load data for the first time
                    await loadDashboardData(principalId);
                }
            });
        });

        // Expose function globally for inline use
        window.viewConsentDetails = viewConsentDetails;
        window.handleLogout = handleLogout;
        window.setActiveTab = setActiveTab;
        window.withdrawConsent = withdrawConsent;
    </script>
</body>
</html>