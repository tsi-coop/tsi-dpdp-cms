<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSI DPDP CMS - User Dashboard</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        /* Base Styling consistent with Collector */
        body { font-family: ui-sans-serif, system-ui, sans-serif; margin: 0; padding: 0; background-color: #f4fbf9; color: #333; }
        .container { padding: 40px 20px; max-width: 1000px; margin: 0 auto; }

        /* Brand Colors */
        :root {
            --tsi-primary: #006A67;
            --tsi-dark: #0f172a;
        }

        /* Card Styling */
        .info-card {
            background: white; padding: 25px; border-radius: 12px;
            border-left: 6px solid var(--tsi-primary); margin-bottom: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Tabs */
        .tab-button {
            padding: 12px 24px;
            font-weight: 600;
            font-size: 0.875rem;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            color: var(--tsi-primary);
            border-bottom-color: var(--tsi-primary);
            background-color: #f0fdfa;
        }

        /* Status Badges */
        .status-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 9999px;
            text-transform: uppercase;
            font-weight: 800;
            border: 1px solid transparent;
        }

        /* Tables */
        .dashboard-table th {
            background-color: #f8fafc;
            text-transform: uppercase;
            font-size: 0.7rem;
            font-weight: 700;
            color: #64748b;
            letter-spacing: 0.05em;
            padding: 12px 16px;
        }
        .dashboard-table td {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.8); display: flex;
            justify-content: center; align-items: center; z-index: 1001;
            display: none;
        }
        .modal-content {
            background-color: white; padding: 35px; border-radius: 12px;
            max-width: 650px; width: 95%; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .action-button {
            background-color: var(--tsi-primary); color: white; border: none;
            padding: 10px 20px; border-radius: 6px;
            cursor: pointer; font-weight: 600; transition: all 0.2s ease;
        }
        .action-button:hover { background-color: #004F4C; transform: translateY(-1px); }
        .action-button:disabled { background-color: #cbd5e1; cursor: not-allowed; }

        /* Configuration Modal */
        .credentials-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .credentials-content {
            background: white; padding: 40px; border-radius: 16px;
            width: 420px; text-align: left; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>

<body>

<div class="container">
  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <a href="index.html"><img src="https://tsicoop.org/logo.svg" alt="TSI Coop" style="height: 50px;"/></a>
    <div class="flex items-center gap-4">
      <button onclick="handleLogout()" class="text-xs font-bold text-red-500 hover:underline">Logout</button>
    </div>
  </div>

  <h1 style="color: #006A67; font-size: 2.25rem; font-weight: 800; margin-bottom: 10px;">Data Principal Dashboard</h1>

  <!-- Profile Card -->
  <div class="info-card">
    <div class="flex justify-between items-start">
      <div>
        <h2 class="text-xl font-bold text-slate-800" id="profile-name">Principal Session</h2>
        <p class="text-sm text-slate-500 mt-1" id="profile-user-id">Principal ID: --</p>
      </div>
      <span class="status-badge bg-teal-100 text-teal-700 border-teal-200">Authenticated</span>
    </div>
  </div>

  <!-- Tabbed Interface -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <div class="flex border-b border-slate-200 bg-slate-50">
      <button id="tab-button-consent" onclick="setActiveTab('consent')" class="tab-button active">Consent History & Manager</button>
      <button id="tab-button-grievance" onclick="setActiveTab('grievance')" class="tab-button">Requests & Grievances</button>
    </div>

    <div id="dashboard-content" class="p-6 min-h-[400px]">
      <div class="flex flex-col items-center justify-center py-20 text-slate-400">
        <div class="w-12 h-12 border-4 border-teal-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-medium">Retrieving your compliance records...</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal: ID Capture / Login -->
<div id="id-capture-modal" class="credentials-modal" style="display:none">
  <div class="credentials-content">
    <h2 style="margin-bottom: 10px; font-size: 1.5rem; font-weight: 700; color: var(--tsi-primary);">Principal Access</h2>
    <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 25px;">Enter your app credentials and Data Principal ID to access your dashboard.</p>

    <form id="id-capture-form">
      <label style="display:block; font-weight:700; font-size: 0.75rem; text-transform: uppercase; color: #475569;">X-API-Key</label>
      <input type="text" id="api-key" required class="w-full p-2 border border-slate-200 rounded-lg mb-3 text-sm font-mono">

      <label style="display:block; font-weight:700; font-size: 0.75rem; text-transform: uppercase; color: #475569;">X-API-Secret</label>
      <input type="password" id="api-secret" required class="w-full p-2 border border-slate-200 rounded-lg mb-3 text-sm font-mono">

      <label style="display:block; font-weight:700; font-size: 0.75rem; text-transform: uppercase; color: #475569;">User ID / Email</label>
      <input type="text" id="input-principal-id" required class="w-full p-2 border border-slate-200 rounded-lg mb-6 text-sm">

      <button type="submit" class="action-button w-full py-3 text-lg">Load My Dashboard</button>
    </form>
  </div>
</div>

<!-- Modal: Submit Grievance -->
<div id="submit-grievance-modal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="text-xl font-bold primary-text mb-4">New Compliance Request</h2>
    <form id="grievance-submission-form" class="space-y-4">
      <div>
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Request Category</label>
        <select id="grievance-type" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50">
          <option value="GENERAL_COMPLAINT">General Inquiry</option>
          <option value="ERASURE_REQUEST">Right to Erasure (Deletion)</option>
          <option value="DATA_ACCESS_REQUEST">Data Portability Request</option>
          <option value="CORRECTION_REQUEST">Correction Request</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Subject</label>
        <input type="text" id="grievance-subject" required placeholder="Brief summary" class="w-full p-3 border border-slate-200 rounded-lg text-sm">
      </div>
      <div>
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Detailed Description</label>
        <textarea id="grievance-description" rows="4" required placeholder="Explain your request..." class="w-full p-3 border border-slate-200 rounded-lg text-sm"></textarea>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button type="button" onclick="document.getElementById('submit-grievance-modal').style.display='none'" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-800">Cancel</button>
        <button type="submit" id="submit-grievance-btn" class="action-button">Submit Request</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Granular Consent Details -->
<div id="detail-modal-overlay" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-start mb-6">
      <div>
        <h2 class="text-xl font-bold primary-text">Consent Record Breakdown</h2>
        <p class="text-[10px] font-mono text-slate-400 uppercase mt-1" id="modal-record-id"></p>
      </div>
      <button onclick="document.getElementById('detail-modal-overlay').style.display='none'" class="text-slate-400 text-2xl">&times;</button>
    </div>

    <div class="space-y-6">
      <div>
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest border-b pb-2 mb-3">Purpose Allowances</h3>
        <div id="granular-details-body" class="space-y-2 text-sm"></div>
      </div>

      <div>
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest border-b pb-2 mb-3">Compliance Context</h3>
        <div id="provenance-details-body" class="p-4 bg-slate-50 rounded-lg text-xs text-slate-600 space-y-2 font-medium"></div>
      </div>
    </div>
  </div>
</div>

<script>
    // --- Configuration & Constants ---
    const API_BASE_URL = 'http://localhost:8080/api/v1';
    const LOCAL_USER_ID_KEY = 'ud_dp_user_id';
    const X_API_KEY = 'ud_x_api_key';
    const X_API_SECRET = 'ud_x_api_secret';

    let consentHistoryCache = [];
    let grievanceCache = [];

    const contentArea = document.getElementById('dashboard-content');

    // UI Headers for robust UTF-8 support
    const getHeaders = () => ({
        'Content-Type': 'application/json; charset=UTF-8',
        'Accept': 'application/json; charset=UTF-8',
        'X-API-Key': localStorage.getItem(X_API_KEY),
        'X-API-Secret': localStorage.getItem(X_API_SECRET)
    });

    // UI Formatting
    function formatTimestamp(iso) { return iso ? new Date(iso).toLocaleString() : 'N/A'; }

    function getStatusBadge(status) {
        // Normalize status strings
        const s = (status || '').toUpperCase();
        const colors = {
            'ACTIVE': 'bg-green-50 text-green-700 border-green-100',
            'CONSENT_GIVEN': 'bg-green-50 text-green-700 border-green-100',
            'RESOLVED': 'bg-green-50 text-green-700 border-green-100',
            'IN_PROGRESS': 'bg-yellow-50 text-yellow-700 border-yellow-100',
            'PENDING_DPO_REVIEW': 'bg-yellow-50 text-yellow-700 border-yellow-100',
            'WITHDRAWN': 'bg-red-50 text-red-700 border-red-100',
            'CONSENT_WITHDRAWN': 'bg-red-50 text-red-700 border-red-100',
            'ERASURE_REQUEST': 'bg-red-50 text-red-700 border-red-100'
        };
        return `<span class="status-badge ${colors[s] || 'bg-slate-50 text-slate-600 border-slate-100'}">${s.replace(/_/g, ' ')}</span>`;
    }

    // --- Core API Functions ---

    async function fetchConsentHistory(userId) {
        try {
            const response = await fetch(`${API_BASE_URL}/client/consent`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({
                    "_func": "list_consent_history",
                    "user_id": userId,
                    "limit": 50
                })
            });
            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (e) { return []; }
    }

    async function fetchGrievances(userId) {
        try {
            const response = await fetch(`${API_BASE_URL}/client/grievance`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({
                    "_func": "list_user_grievances",
                    "user_id": userId
                })
            });
            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (e) { return []; }
    }

    async function withdrawConsent(userId) {
        if (!confirm("CONFIRM: Are you sure you want to withdraw ALL non-mandatory consent? This will trigger a data purge request.")) return;
        try {
            const response = await fetch(`${API_BASE_URL}/client/consent`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({
                    "_func": "withdraw_consent",
                    "user_id": userId,
                    "language_selected": document.documentElement.lang || 'en',
                    "reason": "Withdrawn via User Dashboard."
                })
            });
            if (response.ok) {
                alert("Withdrawal request successful!");
                await loadDashboardData(userId);
            } else { alert("Withdrawal failed. Check API response."); }
        } catch (e) { alert("Network error during withdrawal."); }
    }

    async function erasureRequest(userId) {
        if (!confirm("CONFIRM: Are you sure you want to initiate a COMPLETE erasure? This is irreversible.")) return;
        try {
            const response = await fetch(`${API_BASE_URL}/client/consent`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({
                    "_func": "erasure_request",
                    "user_id": userId,
                    "language_selected": document.documentElement.lang || 'en',
                    "reason": "Complete erasure requested via dashboard."
                })
            });
            if (response.ok) {
                alert("Erasure request submitted successfully!");
                await loadDashboardData(userId);
            } else { alert("Erasure request failed."); }
        } catch (e) { alert("Network error during erasure."); }
    }

    async function submitGrievance(userId, type, subject, description) {
        try {
            const res = await fetch(`${API_BASE_URL}/client/grievance`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({
                    "_func": "submit_grievance",
                    "user_id": userId,
                    "type": type,
                    "subject": subject,
                    "description": description
                })
            });
            return await res.json();
        } catch (e) { return { success: false, message: "Network Error" }; }
    }

    // --- Render Logic ---

    function renderConsentContent(history) {
        const userId = localStorage.getItem(LOCAL_USER_ID_KEY);
        if (!history || history.length === 0) {
            contentArea.innerHTML = `<div class="text-center py-20 text-slate-400 italic">No consent artifacts found in the registry.</div>`;
            return;
        }

        const latest = history[0];
        const mechanism = latest.consent_mechanism;
        // Business logic for disabling buttons
        const canWithdraw = mechanism !== 'CONSENT_WITHDRAWN' && mechanism !== 'ERASURE_REQUEST';
        const canErasure = mechanism !== 'ERASURE_REQUEST';

        let html = `
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-lg font-bold text-slate-800 tracking-tight">Privacy Preferences</h2>
                    <p class="text-xs text-slate-500">Last Action: <strong>${mechanism.replace(/_/g, ' ')}</strong></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="withdrawConsent('${userId}')" ${!canWithdraw ? 'disabled' : ''}
                        class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-all ${canWithdraw ? 'bg-yellow-50 text-yellow-700 hover:bg-yellow-600 hover:text-white border border-yellow-200' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}">
                        Withdraw All
                    </button>
                    <button onclick="erasureRequest('${userId}')" ${!canErasure ? 'disabled' : ''}
                        class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-all ${canErasure ? 'bg-red-50 text-red-700 hover:bg-red-600 hover:text-white border border-red-200' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}">
                        Erasure Request
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left dashboard-table">
                    <thead>
                        <tr>
                            <th>Ref</th>
                            <th>Policy</th>
                            <th>Timestamp</th>
                            <th>Mechanism</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
        `;

        history.forEach(rec => {
            // Intelligent status determination:
            // Use backend status if available, otherwise derive from mechanism
            let displayStatus = rec.status;
            if (!displayStatus || displayStatus === 'ACTIVE') {
                if (rec.consent_mechanism === 'CONSENT_WITHDRAWN') displayStatus = 'WITHDRAWN';
                else if (rec.consent_mechanism === 'ERASURE_REQUEST') displayStatus = 'ERASURE_REQUEST';
                else displayStatus = 'ACTIVE';
            }

            html += `
                <tr class="hover:bg-slate-50">
                    <td class="font-mono text-[10px] text-slate-400">...${rec.id.slice(-6)}</td>
                    <td class="font-bold text-slate-700">${rec.policy_id} <span class="text-[10px] text-slate-400 font-medium">v${rec.policy_version}</span></td>
                    <td class="text-slate-500">${formatTimestamp(rec.timestamp)}</td>
                    <td class="text-slate-500 font-medium text-xs italic">${rec.consent_mechanism.replace(/_/g, ' ')}</td>
                    <td>${getStatusBadge(displayStatus)}</td>
                    <td>
                        <button onclick="viewConsentDetails('${rec.id}')" class="text-teal-600 font-bold hover:underline">Verify Details</button>
                    </td>
                </tr>
            `;
        });

        contentArea.innerHTML = html + `</tbody></table></div><p class="text-[10px] text-slate-400 mt-4 italic">* Mandatory data points required for account functionality are retained until the account is closed.</p>`;
    }

    function renderGrievanceContent(requests) {
        let html = `
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-lg font-bold text-slate-800 tracking-tight">Compliance Redressal</h2>
                    <p class="text-xs text-slate-500">Tracking your formal compliance inquiries and erasure requests.</p>
                </div>
                <button onclick="document.getElementById('submit-grievance-modal').style.display='flex'"
                    class="action-button text-xs uppercase tracking-wider">
                    New Grievance
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left dashboard-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Request Type</th>
                            <th>Subject</th>
                            <th>Deadline</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
        `;

        if (requests.length === 0) {
            html += `<tr><td colspan="5" class="text-center py-20 text-slate-400 italic">No grievances or requests submitted.</td></tr>`;
        } else {
            requests.forEach(req => {
                html += `
                    <tr class="hover:bg-slate-50">
                        <td class="font-mono text-xs text-slate-500">${req.grievance_id}</td>
                        <td class="font-bold text-slate-700 text-xs">${req.type.replace(/_/g, ' ')}</td>
                        <td class="text-slate-600">${req.subject}</td>
                        <td class="text-slate-500 font-medium">${formatTimestamp(req.due_date).split(',')[0]}</td>
                        <td>${getStatusBadge(req.status)}</td>
                    </tr>
                `;
            });
        }

        contentArea.innerHTML = html + `</tbody></table></div>`;
    }

    async function viewConsentDetails(recordId) {
        try {
            const response = await fetch(`${API_BASE_URL}/client/consent`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ "_func": "get_consent_record_details", "record_id": recordId })
            });
            const rec = await response.json();

            document.getElementById('modal-record-id').textContent = "Record Ref: " + rec.id;

            let granular = '';
            const prefs = rec.data_point_consents || {};

            // FIX: Identify if this specific audit record represents a global revocation
            const isWithdrawal = rec.consent_mechanism === 'CONSENT_WITHDRAWN' || rec.status === 'WITHDRAWN';
            const isErasure = rec.consent_mechanism === 'ERASURE_REQUEST' || rec.status === 'ERASURE_REQUEST';

            for (const key in prefs) {
                const item = prefs[key];

                // Intelligent label determination for the popup details
                // If record type is withdrawal/erasure, we force the display to reflect the revocation
                let effectivelyGranted = item.consent_granted;
                if (isWithdrawal || isErasure) {
                    effectivelyGranted = false;
                }

                let statusText = effectivelyGranted ? '✓ GRANTED' : '✕ DENIED';
                if (isWithdrawal) statusText = '✕ WITHDRAWN';
                if (isErasure) statusText = '✕ ERASED';

                granular += `
                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <span class="font-bold text-slate-700 text-xs">${item.purpose_agreed_to || key}</span>
                        <span class="font-black text-[10px] ${effectivelyGranted ? 'text-green-600' : 'text-red-500'}">${statusText}</span>
                    </div>
                `;
            }
            document.getElementById('granular-details-body').innerHTML = granular;

            document.getElementById('provenance-details-body').innerHTML = `
                <p><strong>Policy Version:</strong> ${rec.policy_version}</p>
                <p><strong>Mechanism:</strong> ${rec.consent_mechanism}</p>
                <p><strong>Artifact Timestamp:</strong> ${formatTimestamp(rec.timestamp)}</p>
                <p><strong>Session IP:</strong> ${rec.ip_address || 'Encrypted'}</p>
            `;

            document.getElementById('detail-modal-overlay').style.display = 'flex';
        } catch (e) { alert("Details retrieval failed. Please check connectivity."); }
    }

    async function loadDashboardData(userId) {
        document.getElementById('profile-name').textContent = "Data Principal: " + userId;
        document.getElementById('profile-user-id').textContent = "Session Identity: " + userId;

        const [history, grievances] = await Promise.all([ fetchConsentHistory(userId), fetchGrievances(userId) ]);
        consentHistoryCache = history;
        grievanceCache = grievances;

        setActiveTab('consent');
    }

    function setActiveTab(tabId) {
        document.getElementById('tab-button-consent').className = `tab-button ${tabId === 'consent' ? 'active' : ''}`;
        document.getElementById('tab-button-grievance').className = `tab-button ${tabId === 'grievance' ? 'active' : ''}`;

        if (tabId === 'consent') renderConsentContent(consentHistoryCache);
        else renderGrievanceContent(grievanceCache);
    }

    function handleLogout() {
        localStorage.removeItem(LOCAL_USER_ID_KEY);
        window.location.href = "index.html";
    }

    // --- Bootstrapping ---

    document.addEventListener('DOMContentLoaded', () => {
        const userId = localStorage.getItem(LOCAL_USER_ID_KEY);
        if (!userId) {
            document.getElementById('id-capture-modal').style.display = 'flex';
        } else {
            loadDashboardData(userId);
        }

        document.getElementById('id-capture-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('input-principal-id').value.trim();

            localStorage.setItem(LOCAL_USER_ID_KEY, id);
            localStorage.setItem(X_API_KEY, document.getElementById('api-key').value);
            localStorage.setItem(X_API_SECRET, document.getElementById('api-secret').value);

            document.getElementById('id-capture-modal').style.display = 'none';
            await loadDashboardData(id);
        };

        document.getElementById('grievance-submission-form').onsubmit = async (e) => {
            e.preventDefault();
            const userId = localStorage.getItem(LOCAL_USER_ID_KEY);
            const btn = document.getElementById('submit-grievance-btn');
            btn.disabled = true;

            const res = await submitGrievance(userId,
                document.getElementById('grievance-type').value,
                document.getElementById('grievance-subject').value,
                document.getElementById('grievance-description').value
            );

            if (res.success) {
                alert("Grievance Logged Successfully.");
                document.getElementById('submit-grievance-modal').style.display = 'none';
                grievanceCache = await fetchGrievances(userId);
                setActiveTab('grievance');
            } else {
                alert("Submission Failed: " + (res.message || "Registry unreachable."));
            }
            btn.disabled = false;
        };
    });
</script>
</body>
</html>