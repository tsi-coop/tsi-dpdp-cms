<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSI DPDP CMS - Consent Collection - Tour</title>
    <style>
        /* Existing Styles from previous version */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            display: none; /* Hidden by default until loaded */
        }
        .cookie-banner p {
            margin: 0 15px 0 0;
            flex-grow: 1;
            font-size: 0.9em;
        }
        .cookie-banner button {
            background-color: #006A67;
            color: white;
            border: none;
            padding: 8px 15px;
            margin-left: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        .cookie-banner button:hover {
            background-color: #0056b3;
        }
        .cookie-banner .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Preference Center Styles */
        .preference-center-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            display: none; /* Hidden by default */
        }
        .preference-center-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #333;
            position: relative;
        }
        .preference-center-content h2 {
            margin-top: 0;
            color: #006A67;
            font-size: 1.5em;
        }
        .preference-center-content .category {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .preference-center-content .category h3 {
            margin-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            color: #555;
        }
        .preference-center-content .category p {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        .preference-center-content .category .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .preference-center-content .category .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .preference-center-content .category .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 20px;
        }
        .preference-center-content .category .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        .preference-center-content .category input:checked + .slider {
            background-color: #006A67;
        }
        .preference-center-content .category input:focus + .slider {
            box-shadow: 0 0 1px #006A67;
        }
        .preference-center-content .category input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }
        .preference-center-content .footer-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .cookie-settings-link {
            position: fixed;
            bottom: 50px;
            right: 10px;
            font-size: 0.8em;
            color: #006A67;
            cursor: pointer;
            z-index: 999;
        }

        /* Modal Styles for Credential Input & Linking */
        .credentials-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Highest z-index to appear on top */
        }
        .credentials-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 400px;
            text-align: left;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .credentials-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0 20px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .credentials-content button {
            background-color: #006A67;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        .credentials-content button:hover {
            background-color: #0056b3;
        }
        .credentials-content h2 {
            margin-top: 0;
            color: #006A67;
        }

        /* View Preferences Modal */
        #view-preferences-modal {
            z-index: 1002;
        }
        #json-display {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 300px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Close button for modals */
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            color: #555;
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
        }
    </style>
</head>
<body>

<div style="padding: 20px; max-width: 800px; margin: 0 auto;">
    <a href="https://tsicoop.org" target="_blank"><img src="https://tsicoop.org/logo.svg" alt="TSI Coop Foundation" style="height: 50px;"/></a>
    <h1>TSI DPDP CMS - Consent Collection - Tour</h1>
    <h3>Welcome to Your Privacy Journey with TSI DPDP CMS!</h3>
    <p>Hello and welcome to this interactive tour of the TSI DPDP Consent Management System Client! This tour will walk you through how our system collects consent.</p>

    <h3>Sample Data Fiduciary: TSI Digital Hub</h3>
    <p>TSI Digital Hub is a digital platform that connects business IT departments with solutions, services and talent.</p>

    <h3>Understanding Your Data & Our Purposes</h3>
    <p>Before we dive into the demo, let's briefly look at the types of information we might collect and why. Remember, you control what you share!</p>

    <!-- Content abbreviated for brevity -->

    <h3>Your Interactive Demo Journey: Putting You in Control</h3>
    <p>Let's begin! Follow the steps below and click on the elements within the demo page to see how it all works.</p>

    <h3>Step 1: Your First Interaction - The Consent Banner</h3>
    <p>What you see: When you first visit the site (or if your consent has expired), a Consent Banner will appear at the bottom of your screen.</p>

    <h3>Step 2: Granular Control - Managing Your Preferences</h3>
    <p>Click "Manage My Preferences" on the banner or the "Privacy Choices" link to see granular options.</p>

    <h3>Step 3: Checking Your Choices - "View Preferences"</h3>
    <p>This feature allows you to see the exact JSON representation of your current consent preferences stored in your browser.</p>
    <div id="view-preferences"><strong>Your Action</strong>: Click <a href="#" id="view-preferences-link" style="color: blue; text-decoration: underline;">View Preferences</a> to see your stored consent artifact.</div>

    <h3>Step 4: Linking Your Identity - "Link Principal"</h3>
    <p>Connect your anonymous browsing history with your authenticated account.</p>
    <div id="link-principal"><strong>Your Action</strong>: Click <a href="#" id="link-principal-link" style="color: blue; text-decoration: underline;">Link Principal</a> to simulate login and link your data.</div>

    <h3>Step 5: Consent-Gated Features - "Add Post" & "Provider Zone"</h3>
    <p><strong>Your Action (Add Post):</strong></p>
    <div id="validate-add-post">Click <a href="#" id="add-post-link" style="color: blue; text-decoration: underline;">Add Post</a> (Requires 'Community Engagement')</div>

    <p><strong>Your Action (Provider Zone):</strong></p>
    <div id="validate-provider-zone">Click <a href="#" id="provider-zone-link" style="color: blue; text-decoration: underline;">Provider Zone</a> (Requires 'Solutions & Services Showcase')</div>

    <h3>Conclusion: Trust, Transparency, and Control</h3>
    <p>This tour demonstrates how TSI Digital Hub empowers you to manage your privacy.</p>
    <p><strong>Thank you for taking the tour!</strong></p>
</div>

<!-- Credentials Modal (Initial Setup) -->
<div id="credentials-modal" class="credentials-modal" style="display: none;">
    <div class="credentials-content">
        <h2>ConfigureC</h2>
        <p style="font-size: 0.9em; color: #666;">Please enter your API credentials & Policy Id to connect to the TSI DPDP CMS backend.</p>

        <label for="api-key" style="display:block; margin-top:10px; font-weight:bold;">X-API-Key</label>
        <input type="text" id="api-key" placeholder="Enter API Key">

        <label for="api-secret" style="display:block; margin-top:10px; font-weight:bold;">X-API-Secret</label>
        <input type="text" id="api-secret" placeholder="Enter API Secret (Raw Key)">

        <label for="policy-id" style="display:block; margin-top:10px; font-weight:bold;">Policy Id</label>
        <input type="text" id="policy-id" placeholder="Enter Policy Id">

        <button id="save-credentials-btn">Start Tour</button>
    </div>
</div>

<!-- Link Principal Modal -->
<div id="link-user-modal" class="credentials-modal" style="display: none;">
    <div class="credentials-content" style="position: relative;">
        <button class="modal-close-btn" onclick="document.getElementById('link-user-modal').style.display='none'">&times;</button>
        <h2>Link Identity</h2>
        <p style="font-size: 0.9em; color: #666;">Simulate login to link your anonymous consent history.</p>

        <label for="user-email" style="display:block; margin-top:10px; font-weight:bold;">Email (User ID)</label>
        <input type="email" id="user-email" placeholder="user@example.com">

        <button id="submit-link-user-btn">Login & Link Account</button>
    </div>
</div>

<!-- View Preferences Modal -->
<div id="view-preferences-modal" class="preference-center-overlay">
    <div class="preference-center-content">
        <button class="modal-close-btn" onclick="document.getElementById('view-preferences-modal').style.display='none'">&times;</button>
        <h2>Current Consent Artifact</h2>
        <p>This is the JSON record of your consent currently stored in your browser.</p>
        <pre id="json-display"></pre>
    </div>
</div>

<!-- Consent Banner -->
<div id="cookie-consent-banner" class="cookie-banner">
    <!-- Dynamic Content -->
</div>

<!-- Preference Center -->
<div id="preference-center-overlay" class="preference-center-overlay">
    <div class="preference-center-content">
        <!-- Dynamic Content -->
        <div class="footer-buttons">
            <button id="save-preferences">Save Choices</button>
        </div>
    </div>
</div>

<a href="#" id="open-cookie-settings" class="cookie-settings-link">Privacy Choices</a>

<!-- Configuration -->
<script type="application/json" id="config-data">
    {
        "tsi_dpdp_cms_localstoragekey": "tsi_dpdp_cms_key",
        "tsi_dpdp_cms_apibaseurl": "http://localhost:8080",
        "tsi_dpdp_cms_consentexpiry": 365
    }
</script>

<!-- Main Application Script -->
<script>
    // --- Configuration & Globals ---
    const config = JSON.parse(document.getElementById('config-data').textContent);
    const CONSENT_KEY = config.tsi_dpdp_cms_localstoragekey;
    const API_BASE_URL = config.tsi_dpdp_cms_apibaseurl;

    // Local Storage Keys for Credentials
    const CRED_KEY_API_KEY = 'tsi_cms_api_key';
    const CRED_KEY_API_SECRET = 'tsi_cms_api_secret';
    const POLICY_ID_KEY= 'policy_id_key';
    const USER_ID_KEY = 'tsi_user_id';

    let currentPolicy = null;
    let currentLanguageContent = null;

    // --- DOM Elements ---
    const credentialsModal = document.getElementById('credentials-modal');
    const apiKeyInput = document.getElementById('api-key');
    const apiSecretInput = document.getElementById('api-secret');
    const policyIdInput = document.getElementById('policy-id');
    const saveCredentialsBtn = document.getElementById('save-credentials-btn');

    const cookieBanner = document.getElementById('cookie-consent-banner');
    const preferenceCenterOverlay = document.getElementById('preference-center-overlay');
    const preferenceCenterContent = preferenceCenterOverlay.querySelector('.preference-center-content');
    const savePreferencesBtn = document.getElementById('save-preferences');
    const openCookieSettingsLink = document.getElementById('open-cookie-settings');
    const linkUserModal = document.getElementById('link-user-modal');

    // --- 1. Credential Management (Initial Load) ---

    function checkCredentials() {
        const key = localStorage.getItem(CRED_KEY_API_KEY);
        const secret = localStorage.getItem(CRED_KEY_API_SECRET);

        // Check if both keys exist. If not, show the modal.
        if (!key || !secret) {
            credentialsModal.style.display = 'flex';
        } else {
            // Credentials exist, proceed to initialize the app
            console.log("Credentials found. Initializing...");
            initConsentManager();
        }
    }

    saveCredentialsBtn.addEventListener('click', () => {
        const key = apiKeyInput.value.trim();
        const secret = apiSecretInput.value.trim();
        const policyId = policyIdInput.value.trim();

        if (key && secret) {
            localStorage.setItem(CRED_KEY_API_KEY, key);
            localStorage.setItem(CRED_KEY_API_SECRET, secret);
            localStorage.setItem(POLICY_ID_KEY, policyId);
            credentialsModal.style.display = 'none';
            alert("Credentials Saved! Starting tour...");
            initConsentManager();
        } else {
            alert("Please enter both API Key and Secret to proceed.");
        }
    });

    // --- 2. API Integrations (Using stored credentials) ---

    // GET POLICY
    async function fetchConsentPolicy() {
        const apiKey = localStorage.getItem(CRED_KEY_API_KEY);
        const apiSecret = localStorage.getItem(CRED_KEY_API_SECRET);
        const policyId = localStorage.getItem(POLICY_ID_KEY);

        // Request payload matches curl example
        const payload = {
            "_func": "get_policy",
            "policy_id": policyId
        };

        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/client/policy`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey,
                    'X-API-Secret': apiSecret
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Policy fetch failed: ${response.status} - ${err}`);
            }
            const data = await response.json();
            // Assume data structure matches your Policy JSON format.
            // If backend wraps it in {data: ...}, use data.data
            return data.data || data;
        } catch (error) {
            console.error("Error fetching policy:", error);
            alert("Failed to fetch policy. Please check your API credentials or backend status.");
            return null;
        }
    }

    // RECORD CONSENT
    async function recordConsentAPI(preferences, mechanism) {
        const apiKey = localStorage.getItem(CRED_KEY_API_KEY);
        const apiSecret = localStorage.getItem(CRED_KEY_API_SECRET);

        // Get User ID (Anonymous or Authenticated)
        let userId = localStorage.getItem(USER_ID_KEY);
        if (!userId) {
            // Generate random anonymous ID if none exists
            userId = 'anon_' + Math.random().toString(36).substr(2, 9) + "_" + Date.now();
            localStorage.setItem(USER_ID_KEY, userId);
        }

        // Map preferences object { purpose_id: bool } to array format for API
        const dataPointConsents = Object.keys(preferences).map(purposeId => {
            // Find the purpose details in the current policy to get the name
            const purposeDef = currentLanguageContent.data_processing_purposes.find(p => p.id === purposeId);
            return {
                "data_point_id": purposeId,
                "consent_granted": preferences[purposeId],
                "purpose_agreed_to": purposeDef ? purposeDef.name : purposeId,
                "timestamp_updated": new Date().toISOString()
            };
        });

        // Construct payload matching record_consent.json structure
        const consentPayload = {
            "_func": "record_consent",
            "user_id": userId,
            "policy_id": currentPolicy.policy_id,
            "policy_version": currentPolicy.version,
            "timestamp": new Date().toISOString(),
            "jurisdiction": currentPolicy.jurisdiction || "IN",
            "language_selected": "en",
            "consent_status_general": "custom", // Simplified logic
            "consent_mechanism": mechanism, // e.g. "preference_center_save_click"
            "ip_address": "127.0.0.1", // Browser can't get reliable IP, backend should capture real IP
            "user_agent": navigator.userAgent,
            "data_point_consents": dataPointConsents
        };

        console.log("Sending Consent Payload:", consentPayload);

        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/client/consent`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey,
                    'X-API-Secret': apiSecret
                },
                body: JSON.stringify(consentPayload)
            });

            if (!response.ok) throw new Error(`Consent record failed: ${response.status}`);
            const result = await response.json();
            console.log("Consent recorded successfully:", result);
        } catch (error) {
            console.error("Error recording consent:", error);
        }
    }

    // LINK USER
    async function linkUserAPI(anonymousId, authenticatedId) {
        const apiKey = localStorage.getItem(CRED_KEY_API_KEY);
        const apiSecret = localStorage.getItem(CRED_KEY_API_SECRET);

        // Construct payload matching link_user.json structure
        const payload = {
            "_func": "link_user",
            "anonymous_user_id": anonymousId,
            "authenticated_user_id": authenticatedId
        };

        console.log("Sending Link User Payload:", payload);

        try {
            // Using the /consent endpoint as specified in the user request for linking
            const response = await fetch(`${API_BASE_URL}/api/v1/client/consent`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey,
                    'X-API-Secret': apiSecret
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Link user failed: ${response.status}`);

            const result = await response.json();
            console.log("User linked successfully:", result);
            return true;
        } catch (error) {
            console.error("Error linking user:", error);
            alert("Failed to link user account. See console for details.");
            return false;
        }
    }


    // --- 3. Consent Logic & UI Rendering ---

    function getConsentState() {
        const stored = localStorage.getItem(CONSENT_KEY);
        if (stored) return JSON.parse(stored);
        return null;
    }

    function saveConsentState(preferences, mechanism) {
        // Save to Local Storage
        const consentData = {
            preferences: preferences,
            timestamp: new Date().toISOString(),
            mechanism: mechanism,
            policyVersion: currentPolicy.version,
            policyId: currentPolicy.policy_id
        };
        localStorage.setItem(CONSENT_KEY, JSON.stringify(consentData));

        // Invoke Backend API
        recordConsentAPI(preferences, mechanism);

        // UI Updates
        applyConsent(preferences);
        cookieBanner.style.display = 'none';
        preferenceCenterOverlay.style.display = 'none';
    }

    function applyConsent(preferences) {
        console.log("Applying consent preferences (Enabling/Disabling scripts)...", preferences);
        // Logic to actually enable/disable scripts based on preferences would go here
        // For example, check for 'purpose_website_analytics' and load GA if true
    }

    function renderBanner() {
        if(!currentLanguageContent) return;

        cookieBanner.innerHTML = `
            <p>${currentLanguageContent.description || currentLanguageContent.introduction || 'We use cookies to improve your experience.'}</p>
            <div class="button-group">
                <button id="accept-all">Accept All & Continue</button>
                <button id="reject-essential">Reject Non-Essential</button>
                <button id="manage-prefs">Manage My Preferences</button>
            </div>
        `;

        document.getElementById('accept-all').onclick = () => {
            const prefs = {};
            currentLanguageContent.data_processing_purposes.forEach(p => prefs[p.id] = true);
            saveConsentState(prefs, 'accept_all_banner_click');
        };

        document.getElementById('reject-essential').onclick = () => {
             const prefs = {};
            currentLanguageContent.data_processing_purposes.forEach(p => prefs[p.id] = p.is_mandatory_for_service);
            saveConsentState(prefs, 'reject_all_banner_click');
        };

        document.getElementById('manage-prefs').onclick = openPreferenceCenter;

        cookieBanner.style.display = 'flex';
    }

    function renderPreferenceCenter() {
         // Create the inner container for dynamic content to avoid overwriting footer buttons
         const innerContainer = document.createElement('div');
         innerContainer.id = 'dynamic-form-area';

         let html = `
            <button class="modal-close-btn" onclick="document.getElementById('preference-center-overlay').style.display='none'">&times;</button>
            <h2>${currentLanguageContent.title || 'Manage Preferences'}</h2>
            <p>${currentLanguageContent.general_purpose_description || 'Manage your data settings.'}</p>
         `;

         innerContainer.innerHTML += html;

         currentLanguageContent.data_processing_purposes.forEach(p => {
             const isMandatory = p.is_mandatory_for_service;
             const currentConsent = getConsentState();
             const isChecked = isMandatory || (currentConsent && currentConsent.preferences[p.id]);

             innerContainer.innerHTML += `
                <div class="category">
                    <h3>${p.name} ${isMandatory ? '(Mandatory)' : `<label class="toggle-switch"><input type="checkbox" id="toggle-${p.id}" ${isChecked ? 'checked' : ''} ${isMandatory ? 'disabled' : ''}><span class="slider"></span></label>`}</h3>
                    <p>${p.description}</p>
                    ${isMandatory ? '<p class="details" style="font-size:0.8em; color:red;">*Required for service delivery.</p>' : ''}
                </div>
             `;
         });

         // Clear old content and append the new inner container + footer
         const contentDiv = document.querySelector('.preference-center-content');
         contentDiv.innerHTML = ''; // Clear existing structure
         contentDiv.appendChild(innerContainer);

         // Re-add/attach the static footer and listener (assuming footer is outside the dynamic area)
         const footer = document.createElement('div');
         footer.className = 'footer-buttons';
         footer.innerHTML = `<button id="save-prefs-btn">Save Choices</button>`;
         contentDiv.appendChild(footer);


         document.getElementById('save-prefs-btn').onclick = () => {
             const prefs = {};
             currentLanguageContent.data_processing_purposes.forEach(p => {
                 const toggle = document.getElementById(`toggle-${p.id}`);
                 if(p.is_mandatory_for_service) prefs[p.id] = true;
                 else prefs[p.id] = toggle ? toggle.checked : false;
             });
             saveConsentState(prefs, 'preference_center_save_click');
         };
    }

    function openPreferenceCenter() {
        // Re-render to capture latest state if needed
        renderPreferenceCenter();
        preferenceCenterOverlay.style.display = 'flex';
        cookieBanner.style.display = 'none';
    }


    // --- 4. Tour Specific Handlers ---

    document.getElementById('view-preferences-link').onclick = (e) => {
        e.preventDefault();
        const state = getConsentState();
        const display = document.getElementById('json-display');
        const modal = document.getElementById('view-preferences-modal');

        if(state) {
            //display.textContent = JSON.stringify(state, null, 2);
            display.textContent = JSON.stringify(state);
        } else {
            display.textContent = "No consent preferences found in Local Storage. Please interact with the banner first.";
        }
        modal.style.display = 'flex';
    };

    document.getElementById('link-principal-link').onclick = (e) => {
        e.preventDefault();
        const anonId = localStorage.getItem(USER_ID_KEY);

        if(!anonId) {
            alert("No anonymous ID found. Please interact with the site first.");
            return;
        }

        // Simple check to see if we already linked (simulated by checking if ID doesn't start with 'anon_')
        if(!anonId.startsWith('anon_')) {
            alert(`Account already linked! Current Principal ID: ${anonId}`);
        } else {
             linkUserModal.style.display = 'flex';
        }
    };

    document.getElementById('submit-link-user-btn').onclick = async () => {
        const email = document.getElementById('user-email').value;
        if(!email) return alert("Enter email");

        const anonId = localStorage.getItem(USER_ID_KEY);

        // Call Link API
        const success = await linkUserAPI(anonId, email);

        if(success) {
            localStorage.setItem(USER_ID_KEY, email); // Update local ID to authenticated one
            alert(`Success! Anonymous ID '${anonId}' linked to '${email}'. Consent history merged.`);
            linkUserModal.style.display = 'none';
        }
    };

    // Gated Actions
    document.getElementById('add-post-link').onclick = (e) => {
        e.preventDefault();
        const state = getConsentState();
        // Assuming ID from policy matches 'Community Engagement'
        if (state && state.preferences['purpose_community_engagement']) {
            alert("Access Granted: You can now Add a Post.");
        } else {
            if(confirm("Access Denied. 'Community Engagement' consent is required. Open Preferences?")) {
                openPreferenceCenter();
            }
        }
    };

    document.getElementById('provider-zone-link').onclick = (e) => {
        e.preventDefault();
        const state = getConsentState();
        // Assuming ID matches 'Solutions & Services'
        if (state && state.preferences['purpose_solution_service_training_showcase']) {
            alert("Access Granted: Welcome to the Provider Zone.");
        } else {
            if(confirm("Access Denied. 'Solutions & Services Showcase' consent is required. Open Preferences?")) {
                openPreferenceCenter();
            }
        }
    };


    // --- Initialization ---

    async function initConsentManager() {
        console.log("Initializing Consent Manager...");

        // 1. Fetch Policy
        const policyData = await fetchConsentPolicy();

        if (policyData) {
            currentPolicy = policyData;
            // Assume 'policy_content' object exists and default to 'en'
            if(currentPolicy.policy_content && currentPolicy.policy_content.en) {
                currentLanguageContent = currentPolicy.policy_content.en;
                //console.log(currentLanguageContent.title);

                // 2. Initialize UI Builders with fetched content
                renderPreferenceCenter();

                // 3. Check State & Show Banner
                const state = getConsentState();
                if (!state) {
                    renderBanner();
                } else {
                    // Apply existing consent effects
                    applyConsent(state.preferences);
                }
            } else {
                console.error("Invalid policy format: Missing language content.");
            }
        } else {
            console.log("Could not load policy. Consent features disabled.");
        }
    }

    // Start by checking for API credentials
    document.addEventListener('DOMContentLoaded', checkCredentials);

</script>
</body>
</html>